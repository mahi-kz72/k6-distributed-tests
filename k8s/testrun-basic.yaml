apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: k6-basic-test
  namespace: k6-tests
  labels:
    app.kubernetes.io/name: k6
    app.kubernetes.io/component: testrun
    test-type: basic
spec:
  # Number of parallel pods to run the test
  parallelism: 3
  
  # k6 script configuration
  script:
    # Reference to the ConfigMap containing our test script
    configMap:
      name: k6-scripts
      file: test.js
  
  # k6 runner configuration
  runner:
    # Use the official k6 Docker image
    image: grafana/k6:latest
    
    # Resource requests and limits per pod
    # Adjust these based on your test requirements and cluster capacity
    resources:
      requests:
        cpu: "100m"      # Minimum CPU per pod
        memory: "128Mi"  # Minimum memory per pod
      limits:
        cpu: "500m"      # Maximum CPU per pod
        memory: "512Mi"  # Maximum memory per pod
    
    # Environment variables (optional)
    env:
      - name: K6_LOG_LEVEL
        value: "info"
      - name: K6_NO_THRESHOLDS
        value: "true"
      - name: K6_WEB_BASE_URL
        value: "https://testnet.nobitex.ir"
      - name: K6_API_BASE_URL
        value: "https://testnetapiv2.nobitex.ir"

  # No extra CLI arguments; rely on script's handleSummary for outputs

---
# Optional: Service to expose test results (if needed)
apiVersion: v1
kind: Service
metadata:
  name: k6-basic-test-service
  namespace: k6-tests
  labels:
    app.kubernetes.io/name: k6
    app.kubernetes.io/component: testrun
spec:
  selector:
    # This will match the pods created by the TestRun
    testrun: k6-basic-test
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  type: ClusterIP
