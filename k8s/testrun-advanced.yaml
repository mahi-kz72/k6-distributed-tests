apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: k6-advanced-test
  namespace: k6-tests
  labels:
    app.kubernetes.io/name: k6
    app.kubernetes.io/component: testrun
    test-type: advanced
spec:
  # Number of parallel pods to run the test
  # Each pod will execute a unique shard of the test automatically
  parallelism: 5
  
  # k6 script configuration
  script:
    # Reference to the ConfigMap containing our advanced test script
    configMap:
      name: k6-scripts
      file: advanced-test.js
  
  # k6 runner configuration
  runner:
    # Use the official k6 Docker image
    image: grafana/k6:latest
    
    # Resource requests and limits per pod
    # Higher resources for the more intensive advanced test
    resources:
      requests:
        cpu: "200m"      # Higher CPU for advanced test
        memory: "256Mi"  # Higher memory for advanced test
      limits:
        cpu: "1000m"     # Higher CPU limit
        memory: "1Gi"    # Higher memory limit
    
    # Environment variables
    env:
      - name: K6_LOG_LEVEL
        value: "info"
      - name: K6_NO_THRESHOLDS
        value: "true"
      - name: K6_VU_MAX_ITERATIONS
        value: "1000"  # Limit iterations per VU for safety
      - name: K6_WEB_BASE_URL
        value: "https://testnet.nobitex.ir"
      - name: K6_API_BASE_URL
        value: "https://testnetapiv2.nobitex.ir"

  # No extra CLI arguments; outputs can be configured via script or external outputs

---
# Optional: Service to expose test results (if needed)
apiVersion: v1
kind: Service
metadata:
  name: k6-advanced-test-service
  namespace: k6-tests
  labels:
    app.kubernetes.io/name: k6
    app.kubernetes.io/component: testrun
spec:
  selector:
    # This will match the pods created by the TestRun
    testrun: k6-advanced-test
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  type: ClusterIP
