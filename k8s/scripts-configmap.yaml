apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-scripts
  namespace: k6-tests
  labels:
    app.kubernetes.io/name: k6
    app.kubernetes.io/component: scripts
data:
  # Basic test script - targets Nobitex testnet (override via env)
  test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';
    
    const errorRate = new Rate('errors');
    
    export const options = {
      stages: [
        { duration: '30s', target: 10 },
        { duration: '1m', target: 10 },
        { duration: '30s', target: 0 },
      ],
      thresholds: {
        http_req_duration: ['p(95)<1000'],
        http_req_failed: ['rate<0.1'],
        errors: ['rate<0.1'],
      },
    };
    
    const WEB_BASE_URL = __ENV.K6_WEB_BASE_URL || 'https://testnet.nobitex.ir';
    const API_BASE_URL = __ENV.K6_API_BASE_URL || 'https://testnetapiv2.nobitex.ir';
    const API_PATH = __ENV.K6_API_PATH || '/';
    
    export default function () {
      const response1 = http.get(`${WEB_BASE_URL}/`);
      check(response1, {
        'landing 200': (r) => r.status === 200,
        'landing <1s': (r) => r.timings.duration < 1000,
      });
      errorRate.add(response1.status !== 200);
      sleep(1);
      
      const response2 = http.get(`${API_BASE_URL}${API_PATH}`);
      check(response2, {
        'api 200': (r) => r.status === 200,
        'api <1s': (r) => r.timings.duration < 1000,
      });
      errorRate.add(response2.status !== 200);
      sleep(1);
    }
    
    export function handleSummary(data) {
      return {
        '/tmp/summary.json': JSON.stringify(data, null, 2),
      };
    }

  # Advanced test script - mixes web and API GETs
  advanced-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate, Trend } from 'k6/metrics';
    
    const errorRate = new Rate('errors');
    const responseTime = new Trend('response_time');
    
    export const options = {
      stages: [
        { duration: '1m', target: 20 },
        { duration: '2m', target: 20 },
        { duration: '1m', target: 50 },
        { duration: '2m', target: 50 },
        { duration: '1m', target: 0 },
      ],
      thresholds: {
        http_req_duration: ['p(95)<1000', 'p(99)<2000'],
        http_req_failed: ['rate<0.05'],
        errors: ['rate<0.05'],
        response_time: ['p(95)<800'],
      },
    };
    
    const WEB_BASE_URL = __ENV.K6_WEB_BASE_URL || 'https://testnet.nobitex.ir';
    const API_BASE_URL = __ENV.K6_API_BASE_URL || 'https://testnetapiv2.nobitex.ir';
    const API_PATHS = (__ENV.K6_API_PATHS || '/,/market/stats').split(',');
    
    export default function () {
      const useApi = Math.random() < 0.7;
      const endpoint = useApi ? API_PATHS[Math.floor(Math.random() * API_PATHS.length)] : '/';
      const base = useApi ? API_BASE_URL : WEB_BASE_URL;
      const url = `${base}${endpoint}`;
      
      const startTime = Date.now();
      const response = http.get(url);
      const duration = Date.now() - startTime;
      responseTime.add(duration);
      
      check(response, {
        [`GET ${endpoint} is 2xx`]: (r) => r.status >= 200 && r.status < 300,
        [`GET ${endpoint} < 2000ms`]: (r) => r.timings.duration < 2000,
      });
      
      errorRate.add(response.status < 200 || response.status >= 400);
      sleep(Math.random() * 1.5 + 0.5);
    }
    
    export function handleSummary(data) {
      return {
        '/tmp/advanced-summary.json': JSON.stringify(data, null, 2),
      };
    }
