version: '3.8'

services:
  # Master node - coordinates the test and collects results
  master:
    image: grafana/k6:latest
    container_name: k6-master
    command: >
      run --out json=results.json
      --address 0.0.0.0:6565
      /scripts/test.js
    volumes:
      - ./scripts:/scripts:ro  # Mount test scripts as read-only
      - ./results:/results     # Mount results directory for output
    ports:
      - "6565:6565"  # Master API port
    networks:
      - k6-network
    environment:
      - K6_LOG_LEVEL=info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6565/v1/status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Worker nodes - execute the actual load test
  worker:
    image: grafana/k6:latest
    command: >
      run --address 0.0.0.0:6565
      --no-summary
      /scripts/test.js
    volumes:
      - ./scripts:/scripts:ro  # Mount test scripts as read-only
    networks:
      - k6-network
    environment:
      - K6_LOG_LEVEL=info
    depends_on:
      master:
        condition: service_healthy
    deploy:
      replicas: 2  # Default number of workers

networks:
  k6-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  results:
    driver: local
